---
- name: Deploy Weather Frontend to Kubernetes
  hosts: local
  gather_facts: yes
  vars:
    app_name: weather-frontend
    namespace: weather-app
    docker_image: suyash0405/weather_frontend
    docker_tag: latest
    replicas: 2
    service_type: LoadBalancer
    container_port: 80
    k8s_manifests_dir: "../k8s"

  tasks:
    - name: Check if kubectl is installed
      command: kubectl version --client
      register: kubectl_check
      changed_when: false
      failed_when: false

    - name: Fail if kubectl is not installed
      fail:
        msg: "kubectl is not installed. Please install kubectl first."
      when: kubectl_check.rc != 0

    - name: Check if Kubernetes cluster is accessible
      command: kubectl cluster-info
      register: cluster_check
      changed_when: false
      failed_when: false

    - name: Fail if cluster is not accessible
      fail:
        msg: "Cannot connect to Kubernetes cluster. Make sure minikube or your cluster is running."
      when: cluster_check.rc != 0

    - name: Create namespace
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: "{{ namespace }}"
            labels:
              name: "{{ namespace }}"

    - name: Deploy frontend application
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: "{{ app_name }}"
            namespace: "{{ namespace }}"
            labels:
              app: "{{ app_name }}"
          spec:
            replicas: "{{ replicas }}"
            selector:
              matchLabels:
                app: "{{ app_name }}"
            template:
              metadata:
                labels:
                  app: "{{ app_name }}"
              spec:
                containers:
                - name: "{{ app_name }}"
                  image: "{{ docker_image }}:{{ docker_tag }}"
                  imagePullPolicy: Always
                  ports:
                  - containerPort: "{{ container_port }}"
                    name: http
                  resources:
                    requests:
                      memory: "128Mi"
                      cpu: "100m"
                    limits:
                      memory: "256Mi"
                      cpu: "200m"
                  livenessProbe:
                    httpGet:
                      path: /
                      port: "{{ container_port }}"
                    initialDelaySeconds: 10
                    periodSeconds: 10
                  readinessProbe:
                    httpGet:
                      path: /
                      port: "{{ container_port }}"
                    initialDelaySeconds: 5
                    periodSeconds: 5

    - name: Create service
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Service
          metadata:
            name: "{{ app_name }}"
            namespace: "{{ namespace }}"
            labels:
              app: "{{ app_name }}"
          spec:
            type: "{{ service_type }}"
            selector:
              app: "{{ app_name }}"
            ports:
            - port: "{{ container_port }}"
              targetPort: "{{ container_port }}"
              protocol: TCP
              name: http

    - name: Wait for deployment to be ready
      command: kubectl rollout status deployment/{{ app_name }} -n {{ namespace }}
      register: rollout_result
      changed_when: false

    - name: Get deployment status
      kubernetes.core.k8s_info:
        kind: Deployment
        namespace: "{{ namespace }}"
        name: "{{ app_name }}"
      register: deployment_info

    - name: Display deployment information
      debug:
        msg:
          - "Deployment: {{ app_name }}"
          - "Namespace: {{ namespace }}"
          - "Replicas: {{ deployment_info.resources[0].status.replicas | default(0) }}/{{ replicas }}"
          - "Available Replicas: {{ deployment_info.resources[0].status.availableReplicas | default(0) }}"

    - name: Get service information
      kubernetes.core.k8s_info:
        kind: Service
        namespace: "{{ namespace }}"
        name: "{{ app_name }}"
      register: service_info

    - name: Display service information
      debug:
        msg:
          - "Service: {{ app_name }}"
          - "Type: {{ service_info.resources[0].spec.type }}"
          - "Cluster IP: {{ service_info.resources[0].spec.clusterIP }}"
          - "Ports: {{ service_info.resources[0].spec.ports }}"

    - name: Get minikube service URL (if using minikube)
      command: minikube service {{ app_name }} -n {{ namespace }} --url
      register: minikube_url
      changed_when: false
      failed_when: false
      when: "'minikube' in cluster_check.stdout"

    - name: Display access URL
      debug:
        msg: "Access your application at: {{ minikube_url.stdout }}"
      when: minikube_url is defined and minikube_url.rc == 0
